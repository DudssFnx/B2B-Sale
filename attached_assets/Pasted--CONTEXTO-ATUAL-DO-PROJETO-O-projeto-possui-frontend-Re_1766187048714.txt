ğŸ“Œ CONTEXTO ATUAL DO PROJETO

O projeto possui frontend (React + Vite) e backend (Express) no mesmo repositÃ³rio

O banco Ã© PostgreSQL hospedado no Railway

O ORM utilizado Ã© Drizzle

Existe um schema legado grande, concentrado em um Ãºnico arquivo, que mistura:

usuÃ¡rios

clientes

pedidos

catÃ¡logo

financeiro

permissÃµes

integraÃ§Ãµes externas

Esse schema legado NÃƒO deve ser apagado imediatamente.

ğŸ¯ OBJETIVO DA MIGRAÃ‡ÃƒO

Criar um NOVO MODELO DE BANCO B2B, mais organizado, governado e escalÃ¡vel, com as seguintes premissas:

PRINCÃPIOS IMUTÃVEIS

UsuÃ¡rio â‰  Empresa

Empresa â‰  Cliente final

Produto NÃƒO possui desconto

Desconto ocorre SOMENTE no pedido ou item do pedido

Toda exceÃ§Ã£o comercial deve ser auditÃ¡vel

Arquitetura multi-tenant usando company_id

Um banco Ãºnico para todos os clientes

MigraÃ§Ã£o feita mÃ³dulo por mÃ³dulo

ğŸ§± NOVA ESTRUTURA DE SCHEMA (OBRIGATÃ“RIA)

Crie uma nova pasta de schemas, SEM REMOVER O LEGADO:

shared/schema/
â”œâ”€ legacy.schema.ts            (schema atual, apenas movido)
â”œâ”€ companies.schema.ts
â”œâ”€ users.schema.ts
â”œâ”€ userCompanies.schema.ts
â”œâ”€ products.schema.ts
â”œâ”€ orders.schema.ts
â”œâ”€ orderItems.schema.ts
â”œâ”€ orderItemDiscount.schema.ts


O arquivo shared/schema/index.ts deve exportar tanto o legado quanto os novos schemas, para permitir convivÃªncia temporÃ¡ria.

ğŸ¢ TABELA: companies

Responsabilidade:

Representar empresas (CNPJ) clientes do sistema

Regras:

Ã‰ a base do multi-tenant

Todos os pedidos, financeiro e permissÃµes dependem de company_id

Campos obrigatÃ³rios:

id (UUID, PK)

razao_social

nome_fantasia

cnpj (unique)

tipo_cliente (ATACADO | VAREJO)

approval_status (PENDENTE | APROVADO | REPROVADO)

ativo

created_at

updated_at

ğŸ‘¤ TABELA: users

Responsabilidade:

Representar pessoas que acessam o sistema

Regras:

UsuÃ¡rio NÃƒO Ã© empresa

UsuÃ¡rio pode atuar em vÃ¡rias empresas

Campos:

id (UUID, PK)

nome

email

senha_hash (ou integraÃ§Ã£o com auth existente)

ativo

created_at

ğŸ”— TABELA: user_companies

Responsabilidade:

Relacionamento N:N entre usuÃ¡rios e empresas

Campos:

id

user_id (FK users)

company_id (FK companies)

role_na_empresa

is_admin

ğŸ“¦ TABELA: products

Responsabilidade:

Produto base do catÃ¡logo

Regras:

Produto NUNCA possui desconto

Produto possui apenas preÃ§o base

Campos:

id

nome

sku (unique)

unidade_medida (UN, CX, KG, MT)

preco_varejo

preco_atacado

status

disponibilidade

ğŸ§¾ TABELA: orders

Responsabilidade:

Representar pedidos/vendas

Regras:

Pedido pertence a UMA empresa

Pedido pode ter vÃ¡rios itens

Status â‰  Etapa (kanban)

Campos:

id

company_id

created_by_user_id

channel (SITE, ADMIN, REPRESENTANTE, API)

status (ORCAMENTO, GERADO, FATURADO, CANCELADO)

etapa (AGUARDANDO, SEPARADO, COBRADO, ENVIADO)

total

created_at

ğŸ§¾ TABELA: order_items

Responsabilidade:

Snapshot comercial do produto no pedido

Campos:

id

order_id

product_id

sku

quantidade

preco_lista

desconto_valor

desconto_percentual

preco_unitario

subtotal

Regra:

NÃƒO usar valor e percentual juntos

ğŸ”’ TABELA: order_item_discounts

Responsabilidade:

GovernanÃ§a de descontos sob autorizaÃ§Ã£o

Campos:

id

order_item_id

solicitado_por_user_id

aprovado_por_user_id

tipo_desconto (VALOR | PERCENTUAL)

valor_solicitado

valor_aprovado

motivo

status (PENDENTE | APROVADO | REJEITADO)

created_at

ğŸ”„ ESTRATÃ‰GIA DE MIGRAÃ‡ÃƒO (OBRIGATÃ“RIA)

NÃƒO remover schema legado

Criar novas tabelas lado a lado

Ajustar services e repositories para:

primeiro usar o novo schema apenas para leitura

depois escrita

Manter contratos de API

NÃ£o alterar frontend neste momento

ğŸ› ï¸ ORIENTAÃ‡Ã•ES DE IMPLEMENTAÃ‡ÃƒO

Use Drizzle ORM

Use enums no PostgreSQL quando aplicÃ¡vel

Crie Ã­ndices quando fizer sentido

NÃ£o crie SQL manual

NÃ£o use CREATE TABLE no painel do banco

Tudo deve nascer do cÃ³digo

ğŸ§ª VALIDAÃ‡ÃƒO

ApÃ³s cada tabela:

Rodar db:push

Verificar criaÃ§Ã£o no Railway

Garantir que nenhuma tabela antiga foi afetada

ğŸš« O QUE NÃƒO FAZER

NÃ£o fundir users e companies

NÃ£o colocar desconto em products

NÃ£o mover lÃ³gica de negÃ³cio para o frontend

NÃ£o apagar dados existentes

NÃ£o renomear rotas sem necessidade